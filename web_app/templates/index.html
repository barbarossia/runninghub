<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunningHub Image Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white p-3 mb-3">
            <div class="col">
                <h1 class="h3 mb-0">
                    <i class="bi bi-images"></i>
                    RunningHub Image Manager
                </h1>
                <small class="opacity-75">Process images with RunningHub AI</small>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-light btn-sm" onclick="showNodesModal()">
                    <i class="bi bi-cpu"></i>
                    Available Nodes
                </button>
            </div>
        </div>

        <!-- Folder Selection -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-folder"></i>
                            Folder Selection
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="folderPath"
                                           placeholder="Select a folder containing images..."
                                           value="{{ image_folder if not current_folder else current_folder }}"
                                           list="folderSuggestions"
                                           onkeypress="if(event.key === 'Enter') { selectFolder(); }"
                                           title="Enter absolute path (e.g., /Users/username/Pictures)">
                                    <button class="btn btn-outline-secondary" onclick="selectFolderWithPicker()"
                                           title="Select a folder">
                                        <i class="bi bi-folder-open"></i>
                                        Select Folder
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showFolderHelp()">
                                        <i class="bi bi-question-circle"></i>
                                        Help
                                    </button>
                                    <button class="btn btn-primary" onclick="selectFolder()">
                                        <i class="bi bi-check-circle"></i>
                                        Load Folder
                                    </button>

                                    <!-- Suggestions for common folders -->
                                    <datalist id="folderSuggestions">
                                        <option value="{{ image_folder }}">
                                        <option value="/Users/{{ current_user }}/Pictures">
                                        <option value="/Users/{{ current_user }}/Desktop">
                                        <option value="/Users/{{ current_user }}/Downloads">
                                        <option value="/tmp">
                                    </datalist>
                                </div>
                                <div id="currentFolderInfo" class="mt-2">
                                    {% if current_folder %}
                                        <small class="text-success">
                                            <i class="bi bi-check-circle-fill"></i>
                                            Current: <code id="currentPathDisplay">{{ current_folder }}</code>
                                            {% if prefix_path %}
                                            <br>
                                            <i class="bi bi-house"></i>
                                            Root Prefix: <code id="prefixPathDisplay">{{ prefix_path }}</code>
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i>
                                            Default: <code>{{ image_folder }}</code>
                                            {% if prefix_path %}
                                            <br>
                                            <i class="bi bi-house"></i>
                                            Root Prefix: <code>{{ prefix_path }}</code>
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-primary" onclick="refreshFolder()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Refresh
                                    </button>
                                    <button class="btn btn-outline-success" onclick="processAllImages()">
                                        <i class="bi bi-play-circle"></i>
                                        Process All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="row mb-3" id="toolbar" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-secondary" onclick="selectAll()">
                                        <i class="bi bi-check-all"></i>
                                        Select All
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="deselectAll()">
                                        <i class="bi bi-x-circle"></i>
                                        Deselect All
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="invertSelection()">
                                        <i class="bi bi-arrow-left-right"></i>
                                        Invert
                                    </button>
                                </div>
                                <span class="ms-3 text-muted">
                                    <span id="selectedCount">0</span> images selected
                                </span>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="setViewMode('list')" data-view="list">
                                        <i class="bi bi-list-ul"></i>
                                        List
                                    </button>
                                    <button class="btn btn-outline-primary active" onclick="setViewMode('grid')" data-view="grid">
                                        <i class="bi bi-grid-3x3-gap"></i>
                                        Grid
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="setViewMode('large')" data-view="large">
                                        <i class="bi bi-grid-3x3-gap-fill"></i>
                                        Large
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-danger" onclick="deleteSelected()">
                                        <i class="bi bi-trash"></i>
                                        Delete
                                    </button>
                                    <button class="btn btn-success" onclick="processSelected()">
                                        <i class="bi bi-play-circle"></i>
                                        Process
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="row">
            <div class="col-12">
                <!-- Folders -->
                <div id="foldersSection" class="mb-4" style="display: none;">
                    <h5><i class="bi bi-folder-fill"></i> Folders</h5>
                    <div id="foldersList" class="row g-3"></div>
                </div>

                <!-- Images -->
                <div id="imagesSection">
                    <h5><i class="bi bi-image-fill"></i> Images</h5>
                    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading images...</p>
                    </div>
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="bi bi-images display-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">No images found</h5>
                        <p class="text-muted">Select a different folder or add images to the current folder.</p>
                    </div>
                    <div id="imagesContainer" class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Processing Images</h5>
                </div>
                <div class="modal-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 100%"></div>
                    </div>
                    <div id="progressLog" class="bg-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div>Starting image processing...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="refreshFolder()" data-bs-dismiss="modal">
                        Close & Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Folder Help Modal -->
    <div class="modal fade" id="folderHelpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-folder-open"></i>
                        How to Select a Folder
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-keyboard"></i> Method 1: Type the Path</h6>
                            <p class="small">Type the full path to your folder in the text field.</p>
                            <div class="bg-light p-2 rounded">
                                <code>/Users/yourname/Pictures</code><br>
                                <code>/Users/yourname/Desktop</code><br>
                                <code>/tmp/images</code>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-terminal"></i> Method 2: Terminal (Recommended)</h6>
                            <p class="small">Open Terminal and use these commands:</p>
                            <div class="bg-light p-2 rounded">
                                <small><code># Get current directory path</code><br>
                                <code>pwd</code><br><br>
                                <code># List contents to verify</code><br>
                                <code>ls -la</code></small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6><i class="bi bi-lightbulb"></i> Quick Tips:</h6>
                    <ul class="small">
                        <li><strong>Mac Finder</strong>: Right-click folder → Hold <kbd>Option</kbd> → Click "Copy as Pathname"</li>
                        <li><strong>Start typing</strong> and select from suggested common folders</li>
                        <li><strong>Default folder</strong>: Uses the configured folder from .env file</li>
                        <li><strong>Subfolders</strong>: Click folder names in the main view to navigate</li>
                    </ul>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Best Practice:</strong> Manual path entry is the most reliable method for selecting folders.
                        <br><br>
                        <strong>Quick Methods to Get Folder Paths:</strong>
                        <ul class="mb-0">
                            <li><strong>Terminal:</strong> Use <code>pwd</code> to get current directory path</li>
                            <li><strong>Mac Finder:</strong> Right-click folder → Hold <kbd>Option</kbd> → "Copy as Pathname"</li>
                            <li><strong>Start typing:</strong> Use the autocomplete suggestions</li>
                        </ul>
                        <br>
                        <strong>Relative Path Support:</strong>
                        <ul class="mb-0">
                            <li><strong>Root Prefix:</strong> <code id="helpPrefixPath">{{ prefix_path if prefix_path else "~/Downloads" }}</code></li>
                            <li><strong>Relative entries:</strong> Enter paths relative to the root prefix (e.g., <code>images</code>, <code>projects/2024</code>)</li>
                            <li><strong>Absolute paths:</strong> Full paths still work as before</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nodes Modal -->
    <div class="modal fade" id="nodesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Available Nodes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="nodesContent">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading nodes...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File System Access API replaces the need for file input -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>